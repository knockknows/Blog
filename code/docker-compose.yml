version: '3.8'

services:
  # Playwright 브라우저 서버
  playwright:
    image: mcr.microsoft.com/playwright:v1.56.0-jammy
    container_name: playwright_server
    command: npx -y playwright@1.56.0 run-server --host 0.0.0.0 --port 3000
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - n8n_network
    restart: unless-stopped

  # FastAPI 애플리케이션
  fastapi:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastapi_scraper
    env_file:
      - .env
    environment:
      - PLAYWRIGHT_SERVER_URL=${PLAYWRIGHT_SERVER_URL:-ws://playwright:3000}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
    ports:
      - "8000:8000"
    depends_on:
      playwright:
        condition: service_healthy
    volumes:
      - ./main_enhanced.py:/app/main.py
    networks:
      - n8n_network
    restart: unless-stopped

# N8N과 같은 네트워크 사용 (외부 네트워크)
networks:
  n8n_network:
    external: true
    name: ${NETWORK_NAME:-n8n_network}  # .env 파일의 NETWORK_NAME 사용
